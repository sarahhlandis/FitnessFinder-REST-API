from marshmallow import fields, validates_schema, validate, validates, ValidationError, Length
from app import ma
from models.facilities import Facility
from datetime import time

class FacilitySchema(ma.SQLAlchemyAutoSchema):
    class Meta:
        model = Facility
        include_fk = True
    
    id = fields.Integer(dump_only=True)
    business_name = fields.String(required=True)
    independent=fields.Boolean(required=True)
    phone_num = fields.String(required=True, validate=[Length(equal=10), validate.Regexp('^\d+$')])
    hours_of_op = fields.Time(required=True, format='%H:%M')

    # foreign keys below
    # Owner will not explicitly set these, so they can be false in order to be populated
    # by the db
    owner_id = fields.Integer(required=False)
    facility_type_id = fields.Integer(required=False)
    address_id = fields.Integer(required=False)

    @validates_schema
    def validate_phone_num(self, data):
        if len(data['phone_num']) != 10:
            raise ValidationError('Phone number must be 10 digits long.')
        
    @validates('hours_of_op')
    def validate_hours_of_op(self, value):
        if value == time(0, 0) or value == time(0, 0, 1):
            # 24/7 is a valid option
            return
        elif value < time(0, 0) or value >= time(24, 0):
            raise ValidationError('Hours of operation must be between 00:00 and 23:59.')